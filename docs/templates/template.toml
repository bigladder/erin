<%#INITIALIZE
# General
parameter "simulation_duration_in_years", :default=>100
parameter "random_setting", :default=>"Auto" # "Auto" | "Seed"
parameter "random_seed", :default=>17
# Load Profile
parameter "load_profile_scenario_id", :default=>["blue_sky", "class_4_hurricane"]
parameter "load_profile_building_id", :default=>["mc", "mc", "other", "other"]
parameter "load_profile_enduse", :default=>["electrical", "electrical", "electrical", "electrical"]
parameter "load_profile_file", :default=>["mc_blue_sky_electrical.csv", "mc_class_4_hurricane_electrical.csv", "other_blue_sky_electrical.csv", "other_class_4_hurricane_electrical.csv"]
# Scenario
parameter "scenario_id", :default=>["blue_sky", "class_4_hurricane"]
parameter "scenario_duration_in_hours", :default=>[8760, 336]
parameter "scenario_max_occurrence", :default=>[1, -1]
parameter "scenario_fixed_frequency_in_years", :default=>[0, 30]
# Building-to-Cluster Connectivity
# Cluster-to-Community Connectivity
# Community-to-Utility Connectivity
# Building Level Configuration
parameter "building_level_building_id", :default=>["mc", "other"]
parameter "building_level_egen_flag", :default=>["FALSE", "FALSE"]
parameter "building_level_egen_eff_pct", :default=>[38.0, 38.0]
#parameter "building_level_egen_peak_pwr_kW", :default=>[100.0, 100.0] # Not currently supported in the engine
parameter "building_level_heat_storage_flag", :default=>["FALSE", "FALSE"]
parameter "building_level_heat_storage_cap_kWh", :default=>[0.0, 0.0]
parameter "building_level_gas_boiler_flag", :default=>["FALSE", "FALSE"]
parameter "building_level_gas_boiler_eff_pct", :default=>[42.0, 42.0]
#parameter "building_level_gas_boiler_peak_heat_gen_kW", :default=>[25.0, 25.0] # Not currently supported in the engine
#parameter "building_level_echiller_flag", :default=>["FALSE", "FALSE"] # Can't handle chillers yet
#parameter "building_level_echiller_peak_cooling_kW", :default=>[50.0, 50.0] # Can't handle chillers yet
#parameter "building_level_echiller_eff_pct", :default=>[540.0, 540.0] # Can't handle chillers yet
# Cluster Level Configuration
# Community Level Configuration
%>
<% require 'set'                                                               %>
<%                                                                             %>
<% def is_true(x)                                                              %>
<%   (x == true) || (x.to_s.downcase.strip == "true")                          %>
<% end                                                                         %>
<%                                                                             %>
<% def equals(x, y)                                                            %>
<%   (x.to_s.downcase.strip == y.to_s.downcase.strip)                          %>
<% end                                                                         %>
<%                                                                             %>
<% enduse_set = Set.new                                                        %>
<% fuels_set = Set.new                                                         %>
<% fuels_set << "electricity"                                                  %>
<% building_level_enduses = {}                                                 %>
<% building_required_fuels = {}                                                %>
<%                                                                             %>
<% load_profile_building_id.each_with_index do |b_id, idx|                     %>
<%   enduse = load_profile_enduse[idx]                                         %>
<%   if !building_level_enduses.include?(b_id)                                 %>
<%     building_level_enduses[b_id] = Set.new([enduse])                        %>
<%   else                                                                      %>
<%     building_level_enduses[b_id] << enduse                                  %>
<%   end                                                                       %>
<%   if enduse == 'electricity'                                                %>
<%     if !building_required_fuels.include?(b_id)                              %>
<%       building_required_fuels[b_id] = Set.new([enduse])                     %>
<%     else                                                                    %>
<%       building_required_fuels[b_id] << enduse                               %>
<%     end                                                                     %>
<%   else                                                                      %>
<%   end                                                                       %>
<% end                                                                         %>
<%                                                                             %>
<% building_level_egen_flag.each_with_index do |flag, idx|                     %>
<%   b_id = building_level_building_id[idx]                                    %>
<%   if is_true(flag)                                                          %>
<%     fuels_set << "natural_gas"                                              %>
<%   end                                                                       %>
<% end                                                                         %>
<%                                                                             %>
<% load_id_set = Set.new                                                       %>
<% load_ids = []                                                               %>
<% num_buildings = building_level_building_id.length                           %>
[simulation_info]
rate_unit = "kW"
quantity_unit = "kJ"
time_unit = "years"
<% if equals(random_setting, "seed")                                           %>
random_seed = <%= random_seed.to_i %>
<% end                                                                         %>
max_time = <%= simulation_duration_in_years %>
############################################################
<% load_profile_building_id.each_with_index do |building_id, idx|              %>
<%   s_id = load_profile_scenario_id[idx]                                      %>
<%   enduse = load_profile_enduse[idx]                                         %>
<%   enduse_set << enduse                                                      %>
<%   file = load_profile_file[idx]                                             %>
<%   load_id = "#{building_id}_#{enduse}_#{s_id}"                              %>
<%   if load_id_set.include?(load_id)                                          %>
<%     puts "WARNING! Duplicate load_id `#{load_id}`"                          %>
<%   end                                                                       %>
<%   load_id_set << load_id                                                    %>
<%   load_ids << load_id                                                       %>
[loads.<%= load_id %>]
csv_file = "<%= file %>"
<% end                                                                         %>
############################################################
<% fuels_set.each do |fuel|                                                    %>
[components.<%= fuel %>_source]
type = "source"
outflow = "<%= fuel %>"
<% end                                                                         %>
<% if num_buildings > 1                                                        %>
[components.building_level_electric_bus]
type = "muxer"
stream = "electricity"
num_inflows = 1
num_outflows = <%= num_buildings %>
dispatch_strategy = "in_order"
<% end                                                                         %>
<% b_id_enduses = Set.new                                                      %>
<% load_profile_building_id.each_with_index do |b_id, idx|                     %>
<%   enduse = load_profile_enduse[idx]                                         %>
<%   tag = "#{b_id}_#{enduse}"                                                 %>
<%   next if b_id_enduses.include?(tag)                                        %>
<%   b_id_enduses << tag                                                       %>
[components.<%= b_id %>_<%= enduse %>]
type = "load"
inflow = "<%= enduse %>"
<%   load_profile_scenario_id.each_with_index do |s_id, idx2|                  %>
<%     if ((load_profile_building_id[idx2] == b_id) and                        %>
<%         (load_profile_enduse[idx2] == enduse))                              %>
<%       load_id = load_ids[idx2]                                              %>
loads_by_scenario.<%= s_id %> = "<%= load_id %>"
<%     end                                                                     %>
<%   end                                                                       %>
<% end                                                                         %>
<% building_level_building_id.sort.each_with_index do |b_id, idx|              %>
<%   if is_true(building_level_egen_flag[idx])                                 %>
[components.<%= b_id %>_electric_generator]
type = "converter"
inflow = "natural_gas"
outflow = "electricity"
lossflow = "waste_heat"
constant_efficiency = <%= building_level_egen_eff_pct[idx].to_f / 100.0 %>
[components.<%= b_id %>_electric_bus]
type = "muxer"
stream = "electricity"
num_inflows = 2
num_outflows = 1
dispatch_strategy = "in_order"
<%   end                                                                       %>
<%   if is_true(building_level_heat_storage_flag[idx])                         %>
[components.<%= b_id %>_heat_storage]
type = "store"
outflow = "heating"
inflow = "heating"
capacity_unit = "kWh"
capacity = <%= building_level_heat_storage_cap_kWh[idx].to_f %>
max_inflow = <%= building_level_heat_storage_cap_kWh[idx].to_f / 10.0 %>
<%   end                                                                       %>
<%   if is_true(building_level_gas_boiler_flag[idx])                           %>
[components.<%= b_id %>_gas_boiler]
type = "converter"
outflow = "heating"
inflow = "natural_gas"
lossflow = "waste_heat"
constant_efficiency = <%= building_level_gas_boiler_eff_pct[idx].to_f %>
<%   end                                                                       %>
<% end                                                                         %>
############################################################
[networks.nw]
connections = [
<% if (num_buildings == 1) and !is_true(building_level_egen_flag[0])           %>
<%   b_id = building_level_building_id[0]                                      %>
  ["electricity_source:OUT(0)", "<%= b_id %>_electricity:IN(0)", "electricity"],
<% else                                                                        %>
  ["electricity_source:OUT(0)", "building_level_electric_bus:IN(0)", "electricity"],
<% end                                                                         %>
<% num_buildings.times do |n|                                                  %>
<%   next if num_buildings == 1 and !is_true(building_level_egen_flag[0])      %>
<%   b_id = building_level_building_id[n]                                      %>
<%   if is_true(building_level_egen_flag[n])                                   %>
  ["building_level_electric_bus:OUT(<%= n %>)", "<%= b_id %>_electric_bus:IN(0)", "electricity"],
  ["<%= b_id %>_electric_generator:OUT(0)", "<%= b_id %>_electric_bus:IN(1)", "electricity"],
  ["<%= b_id %>_electric_bus:OUT(0)", "<%= b_id %>_electricity:IN(0)", "electricity"],
  ["natural_gas_source:OUT(0)", "<%= b_id %>_electric_generator:IN(0)", "natural_gas"],
<%   else                                                                      %>
  ["building_level_electric_bus:OUT(<%= n %>)", "<%= b_id %>_electricity:IN(0)", "electricity"],
<%   end                                                                       %>
<% end                                                                         %>
  ]
############################################################
<% scenario_id.each_with_index do |s_id, idx|                                  %>
[scenarios.<%= s_id %>]
time_unit = "hours"
occurrence_distribution = {type = "fixed", value = <%= (scenario_fixed_frequency_in_years[idx] * 8760).to_i %>, time_unit="hours"}
duration = <%= scenario_duration_in_hours[idx] %>
max_occurrences = <%= scenario_max_occurrence[idx].to_i %>
network = "nw"
<% end                                                                         %>
